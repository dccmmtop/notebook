---
title: work
date: 2023-06-12 10:10:56
tags: [secret]
---

# 需求

1. ~~用户导入慢~~ 【已完成】
2. ~~机构导入~~，部门调整时关系错乱 【已完成】
3. ~~机构导入过慢问题~~ 【已完成】

4. 资源突然没有权限问题 【进行中,搁置，暂时没有找到原因】
   ![](../images/2023-06-05-17-44-12.png)

5. 添加人员为空的部门禁用 【进行中】

## 部门禁用

### 禁用部门以及联动

#### 1. 部门禁用

1. 添加部门禁用字段，数据库添加字段后，切记要更新缓存
2. 禁用部门时，先检查部门以及所有子部门下是否有人。如果有人则不能禁用
3. 更新部门禁用字段，更新缓存

#### 2. 退出所有白名单

1. 搞清楚白名单的业务逻辑
2. 梳理清楚白名单增删查改的时机
3. 梳理清楚删除部门的白名单会影响哪些功能
4. 查找现有代码中部门退出白名单的逻辑，尽量复用那些已经使用最多的代码块

#### 3. 退出所有工作圈子

1. 梳理清楚部门和圈子的关系以及存储模型
2. 梳理部门加入或离开圈子的时机
3. 部门退出圈子的影响
4. 复用代码

#### 4. 取消公众号订阅

1. 梳理清楚公众号和部门的之间的关系以及存储模型
2. 部门和订阅之间的关系
3. 明确影响范围
4. 复用代码


#### 5. 删除应用的可见权限

1. 应用是啥
2. 可见权限又是啥
3. 他们和部门之间的关系是啥
4. 如何删除应用的可见权限
5. 影响范围

### 部门启用
1. 父部门启用后，子部门自动启用
2. 父部门禁用的情况下，子部门不能启用

### 禁用部门之后对该部门自身的影响
1. 停用机构只能删除，不能编辑/新建
2. 给出停用机构标识

### 查找禁用部门入口
TODO
- 当前用户可以操作部门的权限

### 禁用部门之后返回给端上的的数据变动
TODO

# 部门调整对外接口 【已完成】
仅仅涉及调整，不会有新增
# 人员禁用接口 【已完成】


# 日报

- 2023-06-06 部门导入导致的部门编码错乱修复
  原因：
    组织机构层级调整必然导致部门编码发生错乱，但是没有修复动作
  修复方法：
    记录所有发生层级变化的部门，然后仅修复这些部门的编码
    由于引入了部门编码修复的逻辑，会导致执行时间变长，该时间和调整之后部门所辖的所有子部门数量有关

- 2023-06-07 部门导入慢优化
  改动逻辑： 
  1. 空间换时间，减少不必要的查询，可节省80%，优化效果明显 
  2. 减少不必要的数据库更新。以前时全量更新子部门数量，现仅更新发生变化的

- 2023-06-08 梳理部门禁用需求文档,评估影响范围
  改动多，涉及广。级联功能变动点多

- 2023-06-09 从代码逻辑层面梳理，评估难易程度
  代码复杂，逻辑晦涩难懂。暂时没有清晰的头绪，先拆分，逐个模块看吧

- 2023-06-12 部门禁用模块细化
  按照从整体到局部的逻辑拆分,越细越好
  
- 2023-06-13 
  - 部门级联禁用和人数校验
  - 退出高管白名单
- 2023-06-14
  - 被禁用的部门退出所有工作圈
- 2023-06-15
  - 被禁用的部门取消订阅
  - 接口频繁无权限排查
- 2023-06-16
  - 接口频繁无权限排查

- 2023-06-19
  部门层级调整接口 【api_v1】
  1. 如何认证？
  
  禁用部门后移除app的可见权限

- 2023-06-20
  机构树基础组件根据参数是否显示被禁用的部门
- 2023-06-21
  机构树基础组件根据参数是否显示被禁用的部门
- 2023-06-25
  机构树基础组件根据参数是否显示被禁用的部门
- 2023-06-26
  人员组织管理机构树要显示已经禁用的部门
  机构树管理添加禁用入口
- 2023-06-27
  高管白名单不显示被禁用的部门
- 2023-06-28
  工作圈部门不显示被禁用的部门
- 2023-06-29
  工作圈部门不显示被禁用的部门
  只有社区管理员可以修改部门简称
- 2023-06-30
  社区管理员创建的群没有人员限制
- 2023-07-03
  只有社区管理员可以修改部门名称
  上线内容准备
- 2023-07-04
  上线及验证
  公众号群发消息，修改/选择范围，按最新组织架构查询，停用机构（禁用人员）不予展示
- 2023-07-05
  添加应用/应用管理员&可见范围选择 按最新组织架构查询，停用机构不予展示
- 2023-07-06
  修改/应用管理员&可见范围/查询
  修改/应用管理员&可见范围/选择
- 2023-07-07 
  分级管理下禁用的部门不予展示
- 2023-07-10
  分级管理下禁用的部门不予展示




  





# 待查明的问题

~~生产ruby~~ 版本 【已完成】

~~开发分支规范~~： 1. 命令  2. 合并 【已完成】


# 账号密码备忘
wifi: pbcti202303

### 网络接入
11.1.215.157
账号 gs_姓名全拼
密码 Kfcs@123

### 数据库
11.1.196.238 
esns minxing123
SI: orcl

### 测试环境全网管理员

admin
hnnx1234

域管理员
域应用管理员
公众号管理员
审批管理员
人员组织管理员
信息收集管理员
移动考勤管理员
考试管理员
工作汇报管理员
应用可见权限管理员
问题反馈管理员
需求管理
文件库管理员
微党课管理员
数据权限管理
在线答疑管理员
意见箱管理员
巡察举报管理员
工作日报管理员
问卷调查管理员
运营大数据管理员
督办管理员
预警监测管理员
固定资产询价管理员


# ruby 下载代码问题
```shell
git clone --depth=1 git@git.dehuinet.com:ruby_server/ewhine_l.git
cd ewhine_l
git remote set-branches origin '8.3.0'
git fetch --depth 1 origin 8.3.0
git checkout 8.3.0
```


# 
![](../images/2023-06-29-17-30-58.png)
`window.sessionStorage.setItem("DomainId", App.Options.current_domain_id);`