---
title: Redis 的主从和哨兵以及集群架构
date: 2023-03-23 08:01:20
tags: [redis]
---

## Redis 的主从架构

![](../images/2023-03-23-08-05-13.png)

### 主从架构搭建步骤

#### 1. 添加从节点
复制一份 redis.conf 文件，将相关配置修改如下：

```conf
# 如果在不同机器上部署，端口可以不用修改
port 6380
# 把 pid 进程号写入 pidfile 配置的文件
pidfile /var/run/redis_6380.pid  
logfile "6380.log"
# 指定数据存放目录
dir /usr/local/redis-5.0.3/data/6380  

# 需要注释掉 bind
# bind 127.0.0.1（bind 绑定的是自己机器网卡的 ip，如果有多块网卡可以配多个 ip，代表允许客户端通过机器的哪些网卡 ip 去访问，内网一般可以不配置 bind，注释掉即可）

# 配置主从复制
# 从 192.168.2.10 6379 的 redis 实例复制数据，Redis 5.0 之前使用 slaveof
replicaof 192.168.2.10 6379   
# 配置从节点只读
replica-read-only yes  
```
#### 2. 启动从节点
`redis-server redis.conf`

#### 3. 连接从节点
`redis-cli -p 6380`

#### 4. 测试
在主节点 6379 上写如数据，然后在 6380 上看看是否能读取到

#### 5. 同理，再添加一个 6381 节点

### Redis 主从工作原理

1. 如果为一个 master 配置一个 slave ，不管这个 slave 是否第一次连接上 Master， 它都会发送一个 PSYNC 命令给 master， 请求复制数据。
2. master 接收到 PSYNC 命令后，会在后台通过 bgsave 命令，生成最新的 rdb 快照文件，在持久化期间，master 会继续接收客户端请求，**把可能修改数据的请求记录在内存中**，master 会把 rdb 文件发给 slave，salve 接收到 rdb 文件后，保存在本地，然后加载到内存中。 之后，master 会把刚刚记录在内存中的修改数据的命令再发给 slave， slave 再依次执行这些命令。达到数据一致。
3. 当 master 与 slave 之间因为网络问题而断开时， slave 能够自动连接到 master。 如果 master 收到多个 slave 的连接请求，它只会进行一次持久化动作，而不是每个连接一次，然后再把这持久化文件发送给各个 slave。

### 主从全量复制的流程
![](../images/2023-03-23-08-23-27.png)

### 数据的部分复制
当主节点与从节点断开重连后，一般都会进行全量的数据复制，从 2.8 版本开始，redis 可以支持部分数据复制的命令与 master 同步，也就是断点续传。

主节点会在内存中维护一个复制数据用的缓存队列，这个队列保存这**最近一段时间的数据**，master 和 slave 都会维护复制数据的下标 offset，和 master 的进程 id。因此当网络重连后，slave 会请求 master 继续未完成的复制，从所记录的下标位置开始，如果 master 的进程 id 变了，或者在 master 中的缓存队列中找不到这个下标，（意味着从节点的下标 offset 太旧了） 那么将会进行一次全量的数据复制。

流程图如下：
![](../images/2023-03-23-08-32-25.png)

### 主从复制风暴
如果有很多个从节点，多个从节点同时从主节点复制数据，导致主节点压力过大，可以做如下阶梯式架构，让部分从节点从其他从节点复制数据：

![](../images/2023-03-23-08-33-58.png)